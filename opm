#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
OpenClaw Manager

åŠŸèƒ½ï¼š
1) æ£€æµ‹ API æ˜¯å¦å¯ç”¨ï¼ˆcheckï¼‰
2) æ·»åŠ  provider å¹¶è‡ªåŠ¨æ³¨å†Œè¯¥ provider çš„å…¨éƒ¨æ¨¡å‹ï¼ˆaddï¼‰
3) åˆ é™¤ providerï¼ˆæ”¯æŒæ‰¹é‡/åºå·/ç©ºæ ¼åˆ†éš”ï¼‰å¹¶æ¸…ç†å·²æ³¨å†Œæ¨¡å‹ï¼ˆremoveï¼‰
4) åŒæ­¥ provider çš„æ¨¡å‹åˆ° agents.defaults.modelsï¼ˆsyncï¼Œå¯é€‰å•ä¸ª/å¤šé€‰ï¼Œç©ºæ ¼åˆ†éš”ï¼‰
5) åˆ—å‡ºå½“å‰ providerï¼ˆlistï¼Œå¸¦åºå·ï¼‰ï¼Œä»¥åŠå•ä¸ª provider æ¨¡å‹åˆ—è¡¨ï¼ˆmodelsï¼‰
6) å¿«é€Ÿåˆ‡æ¢é»˜è®¤æ¨¡å‹ï¼ˆswitchï¼šæŒ‰ provider+æ¨¡å‹åºå·/åç§°ï¼‰
7) å®‰è£…/è‡ªå®šä¹‰åˆ«åï¼ˆalias-installï¼Œé»˜è®¤åˆ«å opmï¼‰

ç¤ºä¾‹ï¼š
  python3 provider_manager.py check --base-url https://api.xxx.com/v1 --api-key sk-xxx
  python3 provider_manager.py add --name myp --base-url https://api.xxx.com/v1 --api-key sk-xxx
  python3 provider_manager.py remove --names 1 3 myp
  python3 provider_manager.py sync --providers 1 myp
  python3 provider_manager.py models --provider 3
  python3 provider_manager.py switch --provider 3 --model 2
  python3 provider_manager.py alias-install --name opm
"""

import argparse
import getpass
import json
import os
import shlex
import shutil
import signal
import subprocess
import sys
import time
import threading
import re
import unicodedata
import urllib.request
import urllib.error
from typing import Dict, List, Tuple

CONFIG_PATH = "/root/.openclaw/openclaw.json"
DEFAULT_UA = "curl/8.5.0"
THIS_SCRIPT = os.path.abspath(__file__)
MENU_SEP = "=" * 33
MENU_STATUS = {
    "openclaw_ver": "æ£€æµ‹ä¸­...",
    "latest_ver": "æ£€æµ‹ä¸­...",
    "runtime": "æ£€æµ‹ä¸­...",
}
_MENU_PROBE_STARTED = False

INSTALL_STATUS_CACHE = {
    "ts": 0.0,
    "openclaw_ver": "",
    "latest_ver": "",
    "latest_ts": 0.0,
    "runtime": "æœªçŸ¥",
}


def eprint(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)


def run_cmd(cmd, check=True, timeout=None):
    """Run command without shell to avoid quoting issues."""
    try:
        p = subprocess.run(
            cmd,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            timeout=timeout,
        )
    except subprocess.TimeoutExpired as e:
        out = (e.stdout or "") if hasattr(e, "stdout") else ""
        if check:
            raise RuntimeError(
                f"å‘½ä»¤è¶…æ—¶: {' '.join(shlex.quote(x) for x in cmd)}\n{out}"
            )
        return 124, out

    if check and p.returncode != 0:
        raise RuntimeError(f"å‘½ä»¤å¤±è´¥: {' '.join(shlex.quote(x) for x in cmd)}\n{p.stdout}")
    return p.returncode, p.stdout


def load_config():
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


def normalize_base_url(url: str) -> str:
    u = url.strip()
    while u.endswith("/"):
        u = u[:-1]
    if not (u.startswith("http://") or u.startswith("https://")):
        raise ValueError("base-url å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´")
    return u


def split_tokens(raw: str) -> List[str]:
    # æ”¯æŒç©ºæ ¼/é€—å·/åˆ†å·æ··ç”¨ï¼Œå»é‡ä¿æŒé¡ºåº
    if not raw:
        return []
    for ch in [",", ";"]:
        raw = raw.replace(ch, " ")
    toks = [t for t in raw.split() if t.strip()]
    seen = set()
    out = []
    for t in toks:
        if t not in seen:
            seen.add(t)
            out.append(t)
    return out


def fetch_models(base_url: str, api_key: str, timeout: int = 10, ua: str = DEFAULT_UA) -> Tuple[bool, int, List[str], str]:
    """Call GET {base_url}/models with Bearer token and parse model ids."""
    url = f"{normalize_base_url(base_url)}/models"
    req = urllib.request.Request(url, method="GET")
    req.add_header("Authorization", f"Bearer {api_key}")
    req.add_header("Accept", "application/json")
    req.add_header("User-Agent", ua)

    try:
        with urllib.request.urlopen(req, timeout=timeout) as resp:
            status = resp.getcode()
            body = resp.read().decode("utf-8", errors="replace")
    except urllib.error.HTTPError as e:
        body = e.read().decode("utf-8", errors="replace") if hasattr(e, "read") else str(e)
        return False, e.code, [], body
    except Exception as e:
        return False, None, [], str(e)

    try:
        data = json.loads(body)
    except Exception:
        return False, status, [], f"è¿”å›é JSONï¼š{body[:500]}"

    models = []
    items = data.get("data", []) if isinstance(data, dict) else []
    for item in items:
        if isinstance(item, dict) and item.get("id"):
            models.append(str(item["id"]))

    # å»é‡ä¿æŒé¡ºåº
    seen = set()
    model_ids = []
    for m in models:
        if m not in seen:
            seen.add(m)
            model_ids.append(m)

    ok = status == 200 and len(model_ids) > 0
    if ok:
        return True, status, model_ids, body
    return False, status, model_ids, body


def build_provider_models(provider_name, model_ids, inputs, context_window, max_tokens):
    models = []
    for mid in model_ids:
        models.append(
            {
                "id": mid,
                "name": f"{provider_name} / {mid}",
                "input": inputs,
                "cost": {
                    "input": 0,
                    "output": 0,
                    "cacheRead": 0,
                    "cacheWrite": 0,
                },
                "contextWindow": context_window,
                "maxTokens": max_tokens,
            }
        )
    return models


def probe_chat_model(base_url: str, api_key: str, model_id: str, timeout: int = 12, ua: str = DEFAULT_UA) -> Tuple[bool, int, str]:
    """Probe chat/completions for one model; return (ok, status, detail)."""
    url = f"{normalize_base_url(base_url)}/chat/completions"
    body = {
        "model": model_id,
        "messages": [{"role": "user", "content": "ping"}],
        "max_tokens": 8,
    }
    req = urllib.request.Request(url, method="POST", data=json.dumps(body).encode("utf-8"))
    req.add_header("Authorization", f"Bearer {api_key}")
    req.add_header("Content-Type", "application/json")
    req.add_header("Accept", "application/json")
    req.add_header("User-Agent", ua)
    try:
        with urllib.request.urlopen(req, timeout=timeout) as resp:
            txt = resp.read().decode("utf-8", errors="replace")
            return resp.getcode() == 200, resp.getcode(), txt[:200]
    except urllib.error.HTTPError as e:
        txt = e.read().decode("utf-8", errors="replace") if hasattr(e, "read") else str(e)
        return False, e.code, txt[:200]
    except Exception as e:
        return False, 0, str(e)


def filter_models_by_chat(base_url: str, api_key: str, model_ids: List[str], timeout: int, ua: str, max_probe: int = 0) -> Tuple[List[str], List[str]]:
    """
    Validate model ids by probing /chat/completions.
    max_probe=0 means probe all models.
    Returns (ok_models, bad_models).
    """
    ids = model_ids[:]
    if max_probe and max_probe > 0:
        ids = ids[:max_probe]
    ok, bad = [], []
    for mid in ids:
        succ, code, _ = probe_chat_model(base_url, api_key, mid, timeout=timeout, ua=ua)
        if succ:
            ok.append(mid)
        else:
            bad.append(mid)
    # if limited probe, keep unprobed models as-is (append after validated ok)
    if max_probe and max_probe > 0 and len(model_ids) > max_probe:
        remaining = model_ids[max_probe:]
        ok.extend(remaining)
    return ok, bad


def config_set(path_key: str, obj):
    payload = json.dumps(obj, ensure_ascii=False)
    run_cmd(["openclaw", "config", "set", path_key, "--json", payload], check=True)


def restart_gateway():
    # éƒ¨åˆ†ç¯å¢ƒï¼ˆæ—  systemd user busï¼‰ä¸‹ï¼Œopenclaw gateway restart ä¼šè¾ƒæ…¢å¹¶å¤±è´¥
    # è¿™é‡ŒåŠ çŸ­è¶…æ—¶å¹¶ä¼˜å…ˆåˆ¤æ–­æ˜¯å¦å·²å¯è¿é€šï¼Œå‡å°‘å¡é¡¿ä¸é‡å¤æŠ¥é”™
    rc, out = run_cmd(["openclaw", "gateway", "restart"], check=False, timeout=8)
    if rc == 0:
        print("âœ… gateway å·²é‡å¯ï¼ˆopenclaw gateway restartï¼‰")
        return True

    # å¦‚æœ restart å¤±è´¥ä½† gateway RPC æ¢æµ‹æ­£å¸¸ï¼Œè§†ä¸ºå¯ç”¨ï¼Œä¸å†å…œåº•é‡å¯
    try:
        rc_st, out_st = run_cmd(["openclaw", "gateway", "status"], check=False, timeout=8)
        txt = (out_st or "").lower()
        if (rc_st == 0) and (("rpc probe: ok" in txt) or ("probe: ok" in txt)):
            print("âœ… gateway å¯ç”¨ï¼ˆæ£€æµ‹åˆ° RPC probe: okï¼Œè·³è¿‡å…œåº•é‡å¯ï¼‰")
            return True
    except Exception:
        pass

    eprint("âš ï¸ openclaw gateway restart å¤±è´¥ï¼Œå°è¯•å…œåº•é‡å¯...")
    try:
        rc, out = run_cmd(["pgrep", "-f", "openclaw-gateway"], check=False, timeout=5)
        if rc == 0 and out.strip():
            for pid_s in out.strip().splitlines():
                try:
                    os.kill(int(pid_s.strip()), signal.SIGTERM)
                except Exception:
                    pass
            time.sleep(1)
        print("âœ… å·²å‘é€ gateway é‡å¯ä¿¡å·ï¼ˆå…œåº•æ–¹å¼ï¼‰")
        return True
    except Exception as e:
        eprint(f"âŒ å…œåº•é‡å¯ä¹Ÿå¤±è´¥ï¼š{e}")
        return False


def get_provider_list(cfg: Dict) -> List[str]:
    providers = cfg.get("models", {}).get("providers", {})
    if not isinstance(providers, dict):
        return []
    return sorted(providers.keys())


def parse_selection(sel: str, names: List[str]) -> List[str]:
    """
    æ”¯æŒè¾“å…¥ï¼š"1 3 myprovider"ï¼Œæ•°å­—æŒ‰ list åºå·ï¼ˆä»1å¼€å§‹ï¼‰ï¼Œå…¶ä½™æŒ‰åå­—ã€‚
    ä¸ºç©ºåˆ™è¿”å›ç©ºåˆ—è¡¨ï¼ˆè¡¨ç¤ºé»˜è®¤è¡Œä¸ºç”±è°ƒç”¨æ–¹å†³å®šï¼‰ã€‚
    """
    tokens = split_tokens(sel)
    if not tokens:
        return []
    selected = []
    for t in tokens:
        if t.isdigit():
            idx = int(t)
            if 1 <= idx <= len(names):
                selected.append(names[idx - 1])
        else:
            if t in names:
                selected.append(t)
    # å»é‡ä¿æŒé¡ºåº
    seen = set()
    out = []
    for n in selected:
        if n not in seen:
            seen.add(n)
            out.append(n)
    return out


def cmd_check(args):
    base_url = (args.base_url or "").strip()
    api_key = (args.api_key or "").strip()
    ua = args.ua.strip() or DEFAULT_UA

    # äº¤äº’å¼è¾“å…¥ï¼šæ”¯æŒç›´æ¥æ‰§è¡Œ `opm check`
    if not base_url:
        base_url = input("è¯·è¾“å…¥ base-url (ä¾‹å¦‚ https://api.xxx.com/v1ï¼Œè¾“å…¥0å–æ¶ˆ): ").strip()
        if base_url == "0":
            print("å·²å–æ¶ˆ")
            return 0
    if not api_key:
        api_key = getpass.getpass("è¯·è¾“å…¥ api-keyï¼ˆè¾“å…¥0å–æ¶ˆï¼‰: ").strip()
        if api_key == "0":
            print("å·²å–æ¶ˆ")
            return 0

    ok, status, model_ids, detail = fetch_models(base_url, api_key, args.timeout, ua)
    if ok:
        print("âœ… API å¯ç”¨")
        print(f"HTTP: {status}")
        print(f"æ¨¡å‹æ•°: {len(model_ids)}")
        for i, m in enumerate(model_ids, 1):
            print(f"{i}. {m}")
        return 0
    print("âŒ API ä¸å¯ç”¨")
    print(f"HTTP: {status}")
    print(f"è¯¦æƒ…: {detail[:800]}")
    return 2


def cmd_add(args):
    provider = (args.name or "").strip()
    if not provider:
        provider = input("è¯·è¾“å…¥ provider åç§° (ä¾‹å¦‚ myproviderï¼Œè¾“å…¥0å–æ¶ˆ): ").strip()
    if provider == "0":
        print("å·²å–æ¶ˆ")
        return 0
    if not provider:
        raise ValueError("provider name ä¸èƒ½ä¸ºç©º")

    base_url = (args.base_url or "").strip()
    if not base_url:
        base_url = input("è¯·è¾“å…¥ base-url (ä¾‹å¦‚ https://api.xxx.com/v1ï¼Œè¾“å…¥0å–æ¶ˆ): ").strip()
    if base_url == "0":
        print("å·²å–æ¶ˆ")
        return 0
    base_url = normalize_base_url(base_url)

    api_key = (args.api_key or "").strip()
    if not api_key:
        api_key = getpass.getpass("è¯·è¾“å…¥ api-keyï¼ˆè¾“å…¥0å–æ¶ˆï¼‰: ").strip()
    if api_key == "0":
        print("å·²å–æ¶ˆ")
        return 0

    ua = args.ua.strip() or DEFAULT_UA

    ok, status, model_ids, detail = fetch_models(base_url, api_key, args.timeout, ua)
    if not ok:
        print("âŒ å…ˆæ£€æµ‹ API å¤±è´¥ï¼Œå·²å–æ¶ˆæ·»åŠ ")
        print(f"HTTP: {status}")
        print(f"è¯¦æƒ…: {detail[:800]}")
        return 2

    # å¯é€‰ï¼šä»…ä¿ç•™ chat/completions å®æµ‹å¯ç”¨æ¨¡å‹ï¼Œé¿å…â€œèƒ½åˆ—å‡ºä½†è°ƒç”¨404â€
    bad_models = []
    if args.validate_chat:
        model_ids, bad_models = filter_models_by_chat(
            base_url, api_key, model_ids, timeout=args.timeout, ua=ua, max_probe=args.max_probe
        )
        if bad_models:
            print(f"âš ï¸ å·²è¿‡æ»¤ chat ä¸å¯ç”¨æ¨¡å‹: {len(bad_models)}")
        if not model_ids:
            print("âŒ è¿‡æ»¤åæ²¡æœ‰å¯ç”¨æ¨¡å‹ï¼Œå–æ¶ˆæ·»åŠ ")
            return 2

    inputs = [x.strip() for x in split_tokens(args.inputs) if x.strip()]
    if not inputs:
        inputs = ["text", "image"]

    provider_obj = {
        "baseUrl": base_url,
        "apiKey": api_key,
        "api": args.api,
        "models": build_provider_models(
            provider, model_ids, inputs, args.context_window, args.max_tokens
        ),
    }

    print(f"â¡ï¸ æ·»åŠ  provider: {provider}")
    config_set(f"models.providers.{provider}", provider_obj)

    cfg = load_config()
    defaults_models = cfg.get("agents", {}).get("defaults", {}).get("models", {})
    if not isinstance(defaults_models, dict):
        defaults_models = {}

    added = 0
    for mid in model_ids:
        key = f"{provider}/{mid}"
        if key not in defaults_models:
            defaults_models[key] = {}
            added += 1

    config_set("agents.defaults.models", defaults_models)

    if not args.no_restart:
        restart_gateway()

    print("âœ… æ·»åŠ å®Œæˆ")
    print(f"provider: {provider}")
    print(f"æ¨¡å‹æ€»æ•°: {len(model_ids)}")
    print(f"æ–°æ³¨å†Œåˆ° agents.defaults.models: {added}")
    return 0


def cmd_remove(args):
    cfg = load_config()
    names_sorted = get_provider_list(cfg)
    selected = parse_selection(args.names, names_sorted)
    if not selected and args.name:
        selected = parse_selection(args.name, names_sorted)
    if not selected:
        print("âŒ æ²¡æœ‰æŒ‡å®šè¦åˆ é™¤çš„ provider")
        return 1

    providers = cfg.get("models", {}).get("providers", {})
    defaults_models = cfg.get("agents", {}).get("defaults", {}).get("models", {})
    if not isinstance(defaults_models, dict):
        defaults_models = {}

    removed = []
    for pname in selected:
        if pname in providers:
            providers.pop(pname, None)
            removed.append(pname)
        # æ¸…ç†æ³¨å†Œæ¨¡å‹
        to_del = [k for k in list(defaults_models.keys()) if k.startswith(pname + "/")]
        for k in to_del:
            defaults_models.pop(k, None)

    config_set("models.providers", providers)
    config_set("agents.defaults.models", defaults_models)
    print(f"âœ… å·²åˆ é™¤ provider: {', '.join(removed) if removed else 'æ— '}")

    if not args.no_restart:
        restart_gateway()

    return 0


def cmd_sync(args):
    cfg = load_config()
    names_sorted = get_provider_list(cfg)
    defaults_models = cfg.get("agents", {}).get("defaults", {}).get("models", {})
    if not isinstance(defaults_models, dict):
        defaults_models = {}

    targets = parse_selection(args.providers, names_sorted) if args.providers else names_sorted
    added = 0
    removed = 0
    for pname in targets:
        pobj = cfg.get("models", {}).get("providers", {}).get(pname) or {}

        # å¯é€‰ï¼šå…ˆç”¨ chat/completions éªŒè¯ provider æ¨¡å‹å¯ç”¨æ€§
        if args.validate_chat:
            mids = [m.get("id") for m in (pobj.get("models", []) or []) if isinstance(m, dict) and m.get("id")]
            ok_ids, bad_ids = filter_models_by_chat(
                pobj.get("baseUrl", ""),
                pobj.get("apiKey", ""),
                mids,
                timeout=args.timeout,
                ua=args.ua,
                max_probe=args.max_probe,
            )
            valid_ids = ok_ids
            if bad_ids:
                print(f"âš ï¸ {pname} è¿‡æ»¤ä¸å¯ç”¨æ¨¡å‹: {len(bad_ids)}")
                if args.prune:
                    bad_keys = {f"{pname}/{x}" for x in bad_ids}
                    for k in list(defaults_models.keys()):
                        if k in bad_keys:
                            defaults_models.pop(k, None)
                            removed += 1
        else:
            valid_ids = [m.get("id") for m in (pobj.get("models", []) or []) if isinstance(m, dict) and m.get("id")]

        for mid in valid_ids:
            key = f"{pname}/{mid}"
            if key not in defaults_models:
                defaults_models[key] = {}
                added += 1

    config_set("agents.defaults.models", defaults_models)

    if not args.no_restart:
        restart_gateway()

    if removed:
        print(f"âœ… åŒæ­¥å®Œæˆï¼Œæ–°å¢æ³¨å†Œæ¨¡å‹: {added}ï¼Œæ¸…ç†å¤±æ•ˆæ¨¡å‹: {removed}")
    else:
        print(f"âœ… åŒæ­¥å®Œæˆï¼Œæ–°å¢æ³¨å†Œæ¨¡å‹: {added}")
    return 0


def cmd_list(_args):
    cfg = load_config()
    providers = cfg.get("models", {}).get("providers", {})
    defaults_models = cfg.get("agents", {}).get("defaults", {}).get("models", {})
    if not isinstance(defaults_models, dict):
        defaults_models = {}

    names = get_provider_list(cfg)
    print(f"provider æ•°é‡: {len(names)}")
    for idx, pname in enumerate(names, 1):
        pobj = providers.get(pname, {}) if isinstance(providers, dict) else {}
        count = len(pobj.get("models", []) or [])
        reg = len([k for k in defaults_models.keys() if k.startswith(pname + "/")])
        print(f"{idx}. {pname}: provideræ¨¡å‹={count}, å·²æ³¨å†Œ={reg}")
    return 0


def cmd_models(args):
    cfg = load_config()
    names_sorted = get_provider_list(cfg)
    selected = parse_selection(args.provider, names_sorted)
    pname = selected[0] if selected else (args.provider.strip() if args.provider else "")
    if not pname:
        print("âŒ éœ€è¦ --provider æŒ‡å®šï¼ˆåºå·æˆ–åç§°ï¼‰")
        return 1
    providers = cfg.get("models", {}).get("providers", {})
    pobj = providers.get(pname)
    if not pobj:
        print(f"âŒ provider ä¸å­˜åœ¨: {pname}")
        return 1
    models = pobj.get("models", []) or []
    print(f"provider: {pname}, æ¨¡å‹æ•°: {len(models)}")
    for i, m in enumerate(models, 1):
        mid = m.get("id") if isinstance(m, dict) else str(m)
        print(f"{i}. {mid}")
    return 0


def cmd_switch(args):
    cfg = load_config()
    names_sorted = get_provider_list(cfg)
    providers = cfg.get("models", {}).get("providers", {})

    # äº¤äº’å¼é€‰æ‹© provider
    pname = ""
    if args.provider:
        sel = parse_selection(args.provider, names_sorted)
        pname = sel[0] if sel else args.provider.strip()
    while not pname:
        print("è¯·é€‰æ‹© providerï¼ˆåºå·æˆ–åç§°ï¼‰ï¼Œå½“å‰åˆ—è¡¨ï¼š")
        for i, n in enumerate(names_sorted, 1):
            print(f"{i}. {n}")
        try:
            inp = input("providerï¼ˆè¾“å…¥0å–æ¶ˆï¼‰: ").strip()
        except EOFError:
            return 1
        if inp == "0":
            print("å·²å–æ¶ˆ")
            return 0
        sel = parse_selection(inp, names_sorted)
        pname = sel[0] if sel else inp
        if pname and pname not in providers:
            print("âŒ provider ä¸å­˜åœ¨ï¼Œå†è¯•ä¸€æ¬¡")
            pname = ""
    if pname not in providers:
        print(f"âŒ provider ä¸å­˜åœ¨: {pname}")
        return 1

    models = providers[pname].get("models", []) or []
    if not models:
        print(f"âŒ provider æ²¡æœ‰æ¨¡å‹: {pname}")
        return 1

    # äº¤äº’å¼é€‰æ‹©æ¨¡å‹
    mid = None
    if args.model:
        if args.model.isdigit():
            idx = int(args.model)
            if 1 <= idx <= len(models):
                mobj = models[idx - 1]
                mid = mobj.get("id") if isinstance(mobj, dict) else str(mobj)
        else:
            mid = args.model.strip()
    while not mid:
        print(f"æ¨¡å‹åˆ—è¡¨ ({pname}):")
        for i, m in enumerate(models, 1):
            mid_cur = m.get("id") if isinstance(m, dict) else str(m)
            print(f"{i}. {mid_cur}")
        try:
            inp = input("æ¨¡å‹åºå·æˆ–åç§°ï¼ˆç©ºå›è½¦é»˜è®¤ç¬¬1ä¸ªï¼Œè¾“å…¥0å–æ¶ˆï¼‰: ").strip()
        except EOFError:
            return 1
        if inp == "0":
            print("å·²å–æ¶ˆ")
            return 0
        if not inp:
            mobj = models[0]
            mid = mobj.get("id") if isinstance(mobj, dict) else str(mobj)
            break
        if inp.isdigit():
            idx = int(inp)
            if 1 <= idx <= len(models):
                mobj = models[idx - 1]
                mid = mobj.get("id") if isinstance(mobj, dict) else str(mobj)
                break
        else:
            mid = inp
            break

    target = f"{pname}/{mid}"
    config_set("agents.defaults.model.primary", target)
    print(f"âœ… é»˜è®¤æ¨¡å‹å·²åˆ‡æ¢ä¸º: {target}")

    # å¯é€‰ï¼šåŒæ­¥åˆ‡æ¢å½“å‰ä¼šè¯æ¨¡å‹
    if args.session:
        try:
            rc, out = run_cmd(["openclaw", "sessions", "--json"], check=True)
            data = json.loads(out)
            sessions = data.get("sessions", []) if isinstance(data, dict) else []
            if not sessions:
                print("âš ï¸ æœªæ‰¾åˆ°ä¼šè¯ï¼Œè·³è¿‡ä¼šè¯åˆ‡æ¢")
            else:
                latest = max(sessions, key=lambda s: s.get("updatedAt", 0))
                sid = latest.get("sessionId")
                if not sid:
                    print("âš ï¸ æœªæ‰¾åˆ° sessionIdï¼Œè·³è¿‡ä¼šè¯åˆ‡æ¢")
                else:
                    # å°è¯•åˆ‡æ¢å¹¶æ ¡éªŒï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
                    ok = False
                    for attempt in (1, 2):
                        run_cmd(["openclaw", "agent", "--session-id", sid, "--message", f"/model {target}", "--timeout", "60"], check=False)
                        time.sleep(1)
                        try:
                            _, out2 = run_cmd(["openclaw", "sessions", "--json"], check=True)
                            data2 = json.loads(out2)
                            sessions2 = data2.get("sessions", []) if isinstance(data2, dict) else []
                            latest2 = max(sessions2, key=lambda s: s.get("updatedAt", 0)) if sessions2 else {}
                            cur = f"{latest2.get('modelProvider','')}/{latest2.get('model','')}".strip("/")
                            if cur == target:
                                ok = True
                                break
                        except Exception:
                            pass
                    if ok:
                        print(f"âœ… å½“å‰ä¼šè¯å·²åˆ‡æ¢ä¸º: {target}")
                    else:
                        print(f"âš ï¸ ä¼šè¯åˆ‡æ¢æœªç”Ÿæ•ˆï¼Œå½“å‰ä»ä¸º: {cur if 'cur' in locals() else 'unknown'}")
        except Exception as e:
            print(f"âš ï¸ ä¼šè¯åˆ‡æ¢å¤±è´¥: {e}")

    if not args.no_restart:
        restart_gateway()
    return 0


def install_alias(alias_name: str = "opm", path_override: str = ""):
    # å°è¯•ç”¨æˆ·æŒ‡å®šè·¯å¾„ï¼Œå¦åˆ™ /usr/local/binï¼Œå†å…¶æ¬¡ ~/bin
    paths = []
    if path_override:
        paths.append(path_override)
    paths.extend(["/usr/local/bin", os.path.expanduser("~/bin")])
    target = os.path.realpath(THIS_SCRIPT)
    for p in paths:
        try:
            os.makedirs(p, exist_ok=True)
            dst = os.path.join(p, alias_name)
            if os.path.islink(dst) or os.path.exists(dst):
                os.remove(dst)
            os.symlink(target, dst)
            os.chmod(dst, 0o755)
            print(f"âœ… å·²åˆ›å»ºåˆ«åï¼š{dst} -> {target}")
            return 0
        except PermissionError:
            continue
        except Exception as e:
            eprint(f"âš ï¸ åˆ›å»ºåˆ«åå¤±è´¥: {e}")
            continue
    print("âŒ æ— æ³•å†™å…¥ç›®æ ‡è·¯å¾„ï¼›è¯·æ‰‹åŠ¨åˆ›å»º alias æˆ–ä½¿ç”¨ sudoã€‚")
    return 1


def cmd_alias(args):
    name = args.name.strip() or "opm"
    return install_alias(name, args.path.strip())


def clear_screen():
    try:
        os.system("clear" if os.name != "nt" else "cls")
    except Exception:
        pass


def pause_any_key(msg: str = "\næŒ‰ä»»æ„é”®è¿”å›ä¸»ç•Œé¢..."):
    # TTY ä¸‹çœŸæ­£è¯»å–å•é”®ï¼›é TTY å›é€€ä¸ºå›è½¦
    print(msg, end="", flush=True)
    if not sys.stdin.isatty():
        try:
            input()
        except Exception:
            pass
        return

    try:
        import termios
        import tty

        fd = sys.stdin.fileno()
        old = termios.tcgetattr(fd)
        try:
            tty.setraw(fd)
            sys.stdin.read(1)
        finally:
            termios.tcsetattr(fd, termios.TCSADRAIN, old)
        print()
    except Exception:
        try:
            input()
        except Exception:
            pass


def get_primary_model() -> str:
    try:
        cfg = load_config()
        return (
            cfg.get("agents", {})
            .get("defaults", {})
            .get("model", {})
            .get("primary", "(æœªè®¾ç½®)")
        )
    except Exception:
        return "(è¯»å–å¤±è´¥)"


def yes_no(prompt: str, default: bool = False) -> bool:
    tip = "Y/n" if default else "y/N"
    while True:
        try:
            s = input(f"{prompt} [{tip}]: ").strip().lower()
        except (EOFError, KeyboardInterrupt):
            print()
            return default
        if not s:
            return default
        if s == "0":
            return default
        if s in ("y", "yes", "1", "true"):
            return True
        if s in ("n", "no", "false", "2"):
            return False
        print("è¯·è¾“å…¥ y æˆ– nï¼ˆæˆ–ç›´æ¥å›è½¦ï¼‰")


def to_int(raw: str, default: int) -> int:
    try:
        return int(str(raw).strip())
    except Exception:
        return default


def prompt_text(prompt: str, default: str = "", allow_zero_cancel: bool = False):
    try:
        s = input(prompt).strip()
    except EOFError:
        return None if allow_zero_cancel else default
    if allow_zero_cancel and s == "0":
        return None
    if not s:
        return default
    return s


def run_action(func, args_obj) -> int:
    try:
        return int(func(args_obj) or 0)
    except Exception as e:
        eprint(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
        return 1


def command_exists(name: str) -> bool:
    return shutil.which(name) is not None


def openclaw_version() -> str:
    """
    ä¼˜å…ˆç”¨ npm å…¨å±€åŒ…ç‰ˆæœ¬è¯†åˆ« openclaw ç‰ˆæœ¬ã€‚
    """
    if not command_exists("npm"):
        return ""
    rc, out = run_cmd(
        ["npm", "list", "-g", "openclaw", "--depth=0", "--no-update-notifier"],
        check=False,
        timeout=6,
    )
    if rc != 0 or not out:
        return ""

    for line in out.splitlines():
        if "openclaw@" in line:
            m = re.search(r"openclaw@([\w\.-]+)", line)
            if m:
                return m.group(1)
    return ""


def latest_openclaw_version(timeout_sec: int = 6) -> str:
    if not command_exists("npm"):
        return ""
    # å…³é—­ npm æ›´æ–°æç¤ºï¼Œå‡å°‘é¢å¤–å¼€é”€
    rc, out = run_cmd(
        ["npm", "view", "openclaw", "version", "--no-update-notifier"],
        check=False,
        timeout=timeout_sec,
    )
    return out.strip() if rc == 0 else ""


def get_cached_install_status() -> Dict[str, str]:
    return {
        "openclaw_ver": INSTALL_STATUS_CACHE.get("openclaw_ver", "") or "",
        "latest_ver": INSTALL_STATUS_CACHE.get("latest_ver", "") or "",
        "runtime": INSTALL_STATUS_CACHE.get("runtime", "") or "",
    }


def get_install_status(force: bool = False, probe_latest: bool = False) -> Dict[str, str]:
    """
    å®‰è£…çŠ¶æ€ç¼“å­˜ï¼š
    - æœ¬åœ°çŠ¶æ€ï¼ˆopenclawç‰ˆæœ¬ã€è¿è¡ŒçŠ¶æ€ï¼‰é»˜è®¤ 10 ç§’ç¼“å­˜
    - è¿œç«¯æœ€æ–°ç‰ˆæœ¬ï¼ˆnpm viewï¼‰ä»…åœ¨éœ€è¦æ—¶æŸ¥è¯¢ï¼ˆprobe_latest=Trueï¼‰ï¼Œå¹¶åš 10 åˆ†é’Ÿç¼“å­˜

    è¯´æ˜ï¼šè¿›å…¥â€œå®‰è£…æ›´æ–°çŠ¶æ€â€é¡µé¢ä¸å†é»˜è®¤è§¦å‘ npm æŸ¥è¯¢ï¼Œé¿å… CPU/è´Ÿè½½çªå¢ã€‚
    """
    now = time.time()

    # æœ¬åœ°çŠ¶æ€
    if force or (now - float(INSTALL_STATUS_CACHE.get("ts", 0.0)) > 10.0):
        INSTALL_STATUS_CACHE["openclaw_ver"] = openclaw_version() or ""
        INSTALL_STATUS_CACHE["runtime"] = gateway_runtime_status_text()
        INSTALL_STATUS_CACHE["ts"] = now

    # æœ€æ–°ç‰ˆæœ¬ï¼ˆç½‘ç»œï¼‰ä»…æŒ‰éœ€æŸ¥è¯¢
    if probe_latest and (force or (now - float(INSTALL_STATUS_CACHE.get("latest_ts", 0.0)) > 600.0)):
        INSTALL_STATUS_CACHE["latest_ver"] = latest_openclaw_version(timeout_sec=6) or ""
        INSTALL_STATUS_CACHE["latest_ts"] = now

    return {
        "openclaw_ver": INSTALL_STATUS_CACHE.get("openclaw_ver", "") or "",
        "latest_ver": INSTALL_STATUS_CACHE.get("latest_ver", "") or "",
        "runtime": INSTALL_STATUS_CACHE.get("runtime", "æœªçŸ¥") or "æœªçŸ¥",
    }


def install_openclaw_official() -> int:
    print("\nâ¡ï¸ ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬å®‰è£… OpenClaw...")
    rc, out = run_cmd(
        [
            "bash",
            "-lc",
            "curl -fsSL --proto '=https' --tlsv1.2 https://openclaw.ai/install.sh | bash -s -- --no-onboard",
        ],
        check=False,
    )
    print(out[-1200:] if out else "")
    return rc


def update_openclaw_official() -> int:
    print("\nâ¡ï¸ ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬æ›´æ–° OpenClaw...")
    rc, out = run_cmd(
        ["bash", "-lc", "curl -fsSL https://openclaw.ai/install.sh | bash"],
        check=False,
    )
    print(out[-1200:] if out else "")
    return rc


def uninstall_openclaw() -> int:
    if not command_exists("openclaw"):
        print("â„¹ï¸ æœªæ£€æµ‹åˆ° openclawï¼Œæ— éœ€å¸è½½")
        return 0

    print("\nâš ï¸ å¸è½½å°†ç§»é™¤ OpenClaw CLI ä¸æœåŠ¡ï¼Œè¯·è°¨æ…ã€‚")
    if not yes_no("ç¡®è®¤ç»§ç»­å¸è½½ï¼Ÿ", default=False):
        print("å·²å–æ¶ˆå¸è½½")
        return 0

    # ä¼˜å…ˆéäº¤äº’å¸è½½
    rc, out = run_cmd(["openclaw", "uninstall", "--all", "--yes", "--non-interactive"], check=False)
    if rc != 0:
        print("âš ï¸ éäº¤äº’å¸è½½å¤±è´¥ï¼Œå°è¯•æ™®é€šå¸è½½...")
        rc, out = run_cmd(["openclaw", "uninstall"], check=False)
    print(out[-1200:] if out else "")
    return rc


def gateway_action(action: str) -> int:
    if action not in ("status", "start", "stop", "restart"):
        print("âŒ ä¸æ”¯æŒçš„æ“ä½œ")
        return 1
    if not command_exists("openclaw"):
        print("âŒ æœªæ£€æµ‹åˆ° openclawï¼Œæ— æ³•æ“ä½œ gateway")
        return 1

    # å¯¹é½ï¼š
    # - start: å…ˆ stop å† startï¼ˆé¿å…æ®‹ç•™çŠ¶æ€å¯¼è‡´å¯åŠ¨å¼‚å¸¸ï¼‰
    # - stop: å…ˆå°è¯•æ¸…ç† tmux ä¼šè¯ï¼Œå†æ‰§è¡Œ openclaw gateway stop
    if action == "start":
        rc1, out1 = run_cmd(["openclaw", "gateway", "stop"], check=False, timeout=12)
        rc2, out2 = run_cmd(["openclaw", "gateway", "start"], check=False, timeout=12)
        time.sleep(3)
        merged = "\n".join([x.strip() for x in (out1, out2) if x and x.strip()])
        print(merged.strip())
        return 0 if rc2 == 0 else rc2

    if action == "stop":
        # å…ˆæ¸…ç†åä¸º gateway çš„ tmux ä¼šè¯ï¼ˆè‹¥å­˜åœ¨ï¼‰
        run_cmd(["tmux", "kill-session", "-t", "gateway"], check=False, timeout=5)
        rc, out = run_cmd(["openclaw", "gateway", "stop"], check=False, timeout=12)
        print((out or "").strip())
        return rc

    if action == "restart":
        # é£æ ¼ä¿æŒä¸€è‡´ï¼šrestart ç­‰ä»·äº stop + start
        rc1, out1 = run_cmd(["openclaw", "gateway", "stop"], check=False, timeout=12)
        rc2, out2 = run_cmd(["openclaw", "gateway", "start"], check=False, timeout=12)
        time.sleep(3)
        merged = "\n".join([x.strip() for x in (out1, out2) if x and x.strip()])
        print(merged.strip())
        return 0 if rc2 == 0 else rc2

    rc, out = run_cmd(["openclaw", "gateway", action], check=False)
    print(out.strip())
    return rc



def menu_install_update_status() -> int:
    # è¿›å…¥æ­¤é¡µé¢å³æ£€æµ‹ä¸€æ¬¡çŠ¶æ€
    primary = get_primary_model()
    st = get_install_status(force=True, probe_latest=True)

    while True:
        clear_screen()
        cur = st.get("openclaw_ver", "")
        latest = st.get("latest_ver", "")
        runtime = st.get("runtime", "")

        sep = MENU_SEP
        print(sep)
        print("å®‰è£…æ›´æ–°çŠ¶æ€")
        print(sep)
        print(f"é»˜è®¤æ¨¡å‹: {primary}")
        print(f"OpenClawç‰ˆæœ¬: {cur if cur else 'æœªå®‰è£…'}")
        print(f"æœ€æ–°ç‰ˆæœ¬: {latest if latest else 'æœªçŸ¥ï¼ˆnpm ä¸å¯ç”¨æˆ–ç½‘ç»œé—®é¢˜ï¼‰'}")
        print(f"è¿è¡ŒçŠ¶æ€: {runtime if runtime else 'æœªçŸ¥'}")
        print(sep)
        print("1. å®‰è£…/å¸è½½ OpenClaw")
        print("2. æ£€æµ‹æ›´æ–°å¹¶å¯æ›´æ–°")
        print("3. Gateway å¯åŠ¨/åœæ­¢/é‡å¯/çŠ¶æ€")
        print("0. è¿”å›ä¸»èœå•")
        print(sep)

        c = input("\nè¯·è¾“å…¥ç¼–å·: ").strip().lower()
        if c == "0":
            return 0

        if c == "1":
            if cur:
                print(f"âœ… å·²å®‰è£… OpenClawï¼Œç‰ˆæœ¬: {cur}")
                if yes_no("æ˜¯å¦å¸è½½ OpenClawï¼Ÿ", default=False):
                    rc = uninstall_openclaw()
                    print("âœ… å¸è½½å®Œæˆ" if rc == 0 else "âŒ å¸è½½å¤±è´¥")
            else:
                print("â„¹ï¸ æœªå®‰è£… OpenClaw")
                if yes_no("æ˜¯å¦ä½¿ç”¨å®˜æ–¹è„šæœ¬å®‰è£…ï¼Ÿ", default=True):
                    rc = install_openclaw_official()
                    print("âœ… å®‰è£…å®Œæˆ" if rc == 0 else "âŒ å®‰è£…å¤±è´¥")
            st = get_install_status(force=True, probe_latest=True)
            primary = get_primary_model()
            pause_any_key()
            continue

        if c == "2":
            st = get_install_status(force=True, probe_latest=True)
            cur2 = st.get("openclaw_ver", "")
            latest2 = st.get("latest_ver", "")

            if not cur2:
                print("âŒ æœªå®‰è£… OpenClawï¼Œæ— æ³•æ›´æ–°")
                pause_any_key()
                continue
            if not latest2:
                print("âš ï¸ æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼ˆnpm æˆ–ç½‘ç»œé—®é¢˜ï¼‰")
                pause_any_key()
                continue
            print(f"å½“å‰ç‰ˆæœ¬: {cur2}")
            print(f"æœ€æ–°ç‰ˆæœ¬: {latest2}")
            if cur2 == latest2:
                print("âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
            else:
                print("âš ï¸ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬")
                if yes_no("æ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ", default=True):
                    rc = update_openclaw_official()
                    print("âœ… æ›´æ–°å®Œæˆ" if rc == 0 else "âŒ æ›´æ–°å¤±è´¥")
                    st = get_install_status(force=True, probe_latest=True)
                    primary = get_primary_model()
            pause_any_key()
            continue

        if c == "3":
            print("\n1. status  2. start  3. stop  4. restart")
            x = input("è¯·é€‰æ‹©æ“ä½œ: ").strip()
            amap = {"1": "status", "2": "start", "3": "stop", "4": "restart"}
            act = amap.get(x, "")
            if not act:
                print("âŒ æ— æ•ˆæ“ä½œ")
            else:
                rc = gateway_action(act)
                if rc == 0:
                    print("âœ… æ‰§è¡ŒæˆåŠŸ")
                else:
                    print("âŒ æ‰§è¡Œå¤±è´¥")
            st = get_install_status(force=True, probe_latest=True)
            primary = get_primary_model()
            pause_any_key()
            continue

        print("âŒ æ— æ•ˆç¼–å·")
        pause_any_key()


def gateway_runtime_status_text() -> str:
    if not command_exists("openclaw"):
        return "æœªå®‰è£…"

    # è½»é‡æ£€æµ‹ï¼šå…ˆç”¨è¿›ç¨‹ååˆ¤æ–­ï¼Œé¿å…æ¯æ¬¡è°ƒç”¨ openclaw gateway status çš„è¾ƒé«˜å¼€é”€
    rc_pg, _ = run_cmd(["pgrep", "-f", "openclaw-gateway"], check=False, timeout=2)
    return "è¿è¡Œä¸­" if rc_pg == 0 else "æœªè¿è¡Œ"


def refresh_menu_status_once():
    try:
        cur = openclaw_version()
        latest = latest_openclaw_version()
        runtime = gateway_runtime_status_text()
        MENU_STATUS["openclaw_ver"] = cur or "æœªå®‰è£…"
        MENU_STATUS["latest_ver"] = latest or "æœªçŸ¥"
        MENU_STATUS["runtime"] = runtime
    except Exception:
        MENU_STATUS["openclaw_ver"] = MENU_STATUS.get("openclaw_ver") or "æœªçŸ¥"
        MENU_STATUS["latest_ver"] = MENU_STATUS.get("latest_ver") or "æœªçŸ¥"
        MENU_STATUS["runtime"] = MENU_STATUS.get("runtime") or "æœªçŸ¥"


def start_menu_probe_if_needed():
    global _MENU_PROBE_STARTED
    if _MENU_PROBE_STARTED:
        return
    _MENU_PROBE_STARTED = True
    t = threading.Thread(target=refresh_menu_status_once, daemon=True)
    t.start()


def menu_refresh_status_blocking():
    refresh_menu_status_once()


def menu_status_signature() -> str:
    return "|".join(
        [
            str(MENU_STATUS.get("openclaw_ver", "")),
            str(MENU_STATUS.get("latest_ver", "")),
            str(MENU_STATUS.get("runtime", "")),
        ]
    )


def read_choice_with_auto_refresh(prompt: str, redraw_func):
    """
    ä¸»èœå•è¾“å…¥ï¼šæ”¯æŒâ€œçŠ¶æ€å˜åŒ–åè‡ªåŠ¨é‡ç»˜ä¸€æ¬¡â€ã€‚
    ä»…åœ¨ç”¨æˆ·å°šæœªå¼€å§‹è¾“å…¥æ—¶é‡ç»˜ï¼Œé¿å…å¹²æ‰°å…¶ä»–äº¤äº’ã€‚
    """
    if not sys.stdin.isatty():
        try:
            return input(prompt).strip()
        except EOFError:
            return "0"

    fd = None
    old = None
    try:
        import select
        import termios

        fd = sys.stdin.fileno()
        old = termios.tcgetattr(fd)

        # å…³é—­å›æ˜¾/è§„èŒƒæ¨¡å¼ï¼Œæ‰‹åŠ¨å›æ˜¾ï¼Œé¿å…é‡å¤æ•°å­—ä¸å…‰æ ‡é”™ä½
        new = termios.tcgetattr(fd)
        new[3] &= ~(termios.ECHO | termios.ICANON)
        termios.tcsetattr(fd, termios.TCSADRAIN, new)

        buf = ""
        last_sig = menu_status_signature()
        refreshed_once = False

        sys.stdout.write(prompt)
        sys.stdout.flush()

        while True:
            r, _, _ = select.select([sys.stdin], [], [], 0.2)

            sig = menu_status_signature()
            if (not refreshed_once) and (sig != last_sig) and (buf == ""):
                refreshed_once = True
                last_sig = sig
                redraw_func()
                sys.stdout.write("\n" + prompt)
                sys.stdout.flush()

            if not r:
                continue

            ch = sys.stdin.read(1)
            if ch in ("\n", "\r"):
                sys.stdout.write("\n")
                sys.stdout.flush()
                return buf.strip()

            if ch in ("\x03",):  # Ctrl+C
                raise KeyboardInterrupt

            if ch in ("\x7f", "\b"):
                if buf:
                    buf = buf[:-1]
                    sys.stdout.write("\b \b")
                    sys.stdout.flush()
                continue

            if ch and ch.isprintable():
                buf += ch
                sys.stdout.write(ch)
                sys.stdout.flush()

    except KeyboardInterrupt:
        raise
    except Exception:
        try:
            return input(prompt).strip()
        except EOFError:
            return "0"
    finally:
        try:
            if fd is not None and old is not None:
                import termios
                termios.tcsetattr(fd, termios.TCSADRAIN, old)
        except Exception:
            pass


def _wcs_width(s: str) -> int:
    w = 0
    for ch in str(s):
        # CJK/å…¨è§’æŒ‰2å®½ï¼Œå…¶ä»–æŒ‰1å®½
        w += 2 if unicodedata.east_asian_width(ch) in ("W", "F") else 1
    return w


def _fit_line(text: str, inner: int) -> str:
    t = str(text)
    cur = _wcs_width(t)
    if cur > inner:
        out = ""
        used = 0
        for ch in t:
            cw = 2 if unicodedata.east_asian_width(ch) in ("W", "F") else 1
            if used + cw > max(0, inner - 1):
                break
            out += ch
            used += cw
        t = out + "â€¦"
        cur = _wcs_width(t)
    return t + " " * max(0, inner - cur)


def _fit_line_center(text: str, inner: int) -> str:
    t = str(text)
    cur = _wcs_width(t)
    if cur > inner:
        out = ""
        used = 0
        for ch in t:
            cw = 2 if unicodedata.east_asian_width(ch) in ("W", "F") else 1
            if used + cw > max(0, inner - 1):
                break
            out += ch
            used += cw
        t = out + "â€¦"
        cur = _wcs_width(t)
    pad_total = max(0, inner - cur)
    left = pad_total // 2
    right = pad_total - left
    return " " * left + t + " " * right


def _box_print(lines: List[str], width: int = 62):
    inner = width - 4
    print("â•”" + "â•" * (width - 2) + "â•—")
    for i, raw in enumerate(lines):
        if raw == "__SEP__":
            print("â• " + "â•" * (width - 2) + "â•£")
        elif isinstance(raw, str) and raw.startswith("__CENTER__:"):
            text = raw.split(":", 1)[1]
            print("â•‘ " + _fit_line_center(text, inner) + " â•‘")
        else:
            print("â•‘ " + _fit_line(raw, inner) + " â•‘")
    print("â•š" + "â•" * (width - 2) + "â•")


def menu_loop() -> int:
    def draw_main():
        clear_screen()
        sep = MENU_SEP
        print(sep)
        print("OpenClaw Manager")
        print(sep)
        print("1. å®‰è£…æ›´æ–°çŠ¶æ€")
        print("2. åˆ—å‡º providerï¼ˆlistï¼‰")
        print("3. æ£€æµ‹ API å¯ç”¨æ€§ï¼ˆcheckï¼‰")
        print("4. æ·»åŠ  providerï¼ˆaddï¼‰")
        print("5. åŒæ­¥æ¨¡å‹æ³¨å†Œï¼ˆsyncï¼‰")
        print("6. åˆ‡æ¢é»˜è®¤æ¨¡å‹ï¼ˆswitchï¼‰")
        print("7. æŸ¥çœ‹ provider æ¨¡å‹ï¼ˆmodelsï¼‰")
        print("8. åˆ é™¤ providerï¼ˆremoveï¼‰")
        print("9. å®‰è£…/ä¿®å¤åˆ«åï¼ˆalias-installï¼‰")
        print("0. é€€å‡º")
        print(sep)
        print("æç¤ºï¼šå‘½ä»¤è¡Œå¸®åŠ©è¯·ç”¨ opm --cli-help")

    while True:
        draw_main()
        choice = input("\nè¯·è¾“å…¥ç¼–å·: ").strip()
        print()

        if choice == "0":
            print("ğŸ‘‹ å·²é€€å‡º OPM")
            return 0

        if choice == "1":
            menu_install_update_status()
            continue

        if choice == "2":
            run_action(cmd_list, argparse.Namespace())
            pause_any_key()
            continue

        if choice == "3":
            timeout = prompt_text("è¶…æ—¶ç§’æ•°(é»˜è®¤10ï¼Œè¾“å…¥0è¿”å›): ", "10", allow_zero_cancel=True)
            if timeout is None:
                continue
            ua = prompt_text(f"User-Agent(é»˜è®¤ {DEFAULT_UA}ï¼Œè¾“å…¥0è¿”å›): ", DEFAULT_UA, allow_zero_cancel=True)
            if ua is None:
                continue
            run_action(
                cmd_check,
                argparse.Namespace(base_url="", api_key="", timeout=to_int(timeout, 10), ua=ua),
            )
            pause_any_key()
            continue

        if choice == "4":
            validate = yes_no("æ˜¯å¦å¼€å¯ chat å¯ç”¨æ€§éªŒè¯(--validate-chat)", default=True)
            prune_hint = "ï¼ˆæ·»åŠ åœºæ™¯æ—  pruneï¼‰"
            print(f"validate-chat: {'å¼€' if validate else 'å…³'} {prune_hint}")
            timeout = prompt_text("è¶…æ—¶ç§’æ•°(é»˜è®¤10ï¼Œè¾“å…¥0è¿”å›): ", "10", allow_zero_cancel=True)
            if timeout is None:
                continue
            max_probe = prompt_text("max-probe(0=å…¨é‡ï¼Œè¾“å…¥0ç»§ç»­ï¼›è‹¥è¦è¿”å›è¯·è¾“å…¥ q): ", "0", allow_zero_cancel=False)
            if str(max_probe).lower() == "q":
                continue
            ua = prompt_text(f"User-Agent(é»˜è®¤ {DEFAULT_UA}ï¼Œè¾“å…¥0è¿”å›): ", DEFAULT_UA, allow_zero_cancel=True)
            if ua is None:
                continue
            no_restart = yes_no("ä»…æ”¹é…ç½®ä¸é‡å¯ gateway(--no-restart)", default=False)
            run_action(
                cmd_add,
                argparse.Namespace(
                    name="",
                    base_url="",
                    api_key="",
                    api="openai-completions",
                    inputs="text image",
                    context_window=131072,
                    max_tokens=8192,
                    timeout=to_int(timeout, 10),
                    ua=ua,
                    validate_chat=validate,
                    max_probe=to_int(max_probe, 0),
                    no_restart=no_restart,
                ),
            )
            pause_any_key()
            continue

        if choice == "5":
            print("å½“å‰ provider åˆ—è¡¨ï¼š")
            run_action(cmd_list, argparse.Namespace())
            providers = prompt_text("è¦åŒæ­¥çš„ providerï¼ˆåºå·/åç§°ï¼Œç©º=å…¨éƒ¨ï¼Œè¾“å…¥0è¿”å›ï¼‰: ", "", allow_zero_cancel=True)
            if providers is None:
                continue
            validate = yes_no("æ˜¯å¦å¼€å¯ chat å¯ç”¨æ€§éªŒè¯(--validate-chat)", default=True)
            prune = False
            if validate:
                prune = yes_no("æ˜¯å¦æ¸…ç†å¤±æ•ˆæ¨¡å‹(--prune)", default=True)
            timeout = prompt_text("è¶…æ—¶ç§’æ•°(é»˜è®¤10ï¼Œè¾“å…¥0è¿”å›): ", "10", allow_zero_cancel=True)
            if timeout is None:
                continue
            max_probe = prompt_text("max-probe(0=å…¨é‡): ", "0", allow_zero_cancel=False)
            ua = prompt_text(f"User-Agent(é»˜è®¤ {DEFAULT_UA}ï¼Œè¾“å…¥0è¿”å›): ", DEFAULT_UA, allow_zero_cancel=True)
            if ua is None:
                continue
            no_restart = yes_no("ä»…æ”¹é…ç½®ä¸é‡å¯ gateway(--no-restart)", default=False)
            run_action(
                cmd_sync,
                argparse.Namespace(
                    providers=providers,
                    validate_chat=validate,
                    prune=prune,
                    timeout=to_int(timeout, 10),
                    ua=ua,
                    max_probe=to_int(max_probe, 0),
                    no_restart=no_restart,
                ),
            )
            pause_any_key()
            continue

        if choice == "6":
            session = yes_no("æ˜¯å¦åŒæ­¥åˆ‡æ¢å½“å‰ä¼šè¯æ¨¡å‹(--session)", default=True)
            no_restart = yes_no("ä»…æ”¹é…ç½®ä¸é‡å¯ gateway(--no-restart)", default=False)
            run_action(
                cmd_switch,
                argparse.Namespace(provider="", model="", session=session, no_restart=no_restart),
            )
            pause_any_key()
            continue

        if choice == "7":
            print("å½“å‰ provider åˆ—è¡¨ï¼š")
            run_action(cmd_list, argparse.Namespace())
            provider = prompt_text("è¯·è¾“å…¥ provider åºå·æˆ–åç§°ï¼ˆè¾“å…¥0è¿”å›ï¼‰: ", "", allow_zero_cancel=True)
            if provider is None:
                continue
            run_action(cmd_models, argparse.Namespace(provider=provider))
            pause_any_key()
            continue

        if choice == "8":
            print("å½“å‰ provider åˆ—è¡¨ï¼š")
            run_action(cmd_list, argparse.Namespace())
            names = prompt_text("è¦åˆ é™¤çš„ providerï¼ˆåºå·/åç§°ï¼Œç©ºæ ¼åˆ†éš”ï¼Œè¾“å…¥0è¿”å›ï¼‰: ", "", allow_zero_cancel=True)
            if names is None:
                continue
            no_restart = yes_no("ä»…æ”¹é…ç½®ä¸é‡å¯ gateway(--no-restart)", default=False)
            run_action(cmd_remove, argparse.Namespace(name="", names=names, no_restart=no_restart))
            pause_any_key()
            continue

        if choice == "9":
            name = prompt_text("åˆ«ååç§°(é»˜è®¤ opmï¼Œè¾“å…¥0è¿”å›): ", "opm", allow_zero_cancel=True)
            if name is None:
                continue
            path = prompt_text("å®‰è£…è·¯å¾„(é»˜è®¤ /usr/local/bin æˆ– ~/binï¼Œè¾“å…¥0è¿”å›): ", "", allow_zero_cancel=True)
            if path is None:
                continue
            run_action(cmd_alias, argparse.Namespace(name=name, path=path))
            pause_any_key()
            continue

        print("âŒ æ— æ•ˆç¼–å·ï¼Œè¯·é‡è¯•")
        pause_any_key()


def build_parser():
    p = argparse.ArgumentParser(
        description="OpenClaw provider ç®¡ç†è„šæœ¬ï¼ˆCLI æ¨¡å¼ï¼‰",
        formatter_class=argparse.RawTextHelpFormatter,
        epilog=(
            "ç¤ºä¾‹:\n"
            "  opm ad --name demo1 --base-url https://api.xxxx.com/v1 --api-key <key> --validate-chat\n"
            "  opm sy --providers demo2 --validate-chat --prune\n"
            "  opm sw --session\n"
            "\n"
            "æç¤º:\n"
            "  opm æˆ– opm -h    è¿›å…¥æ•°å­—èœå•ä¸»ç•Œé¢\n"
            "  opm --cli-help  æŸ¥çœ‹æœ¬é¡µ CLI å¸®åŠ©\n"
        ),
    )
    sub = p.add_subparsers(dest="cmd", required=True)

    p_check = sub.add_parser("check", aliases=["ck"], help="æ£€æµ‹ API æ˜¯å¦å¯ç”¨ï¼ˆæ”¯æŒäº¤äº’è¾“å…¥ï¼‰")
    p_check.add_argument("--base-url", default="", help="ä¾‹å¦‚: https://api.xxx.com/v1ï¼›ä¸å¡«åˆ™äº¤äº’è¾“å…¥")
    p_check.add_argument("--api-key", default="", help="API Keyï¼›ä¸å¡«åˆ™äº¤äº’è¾“å…¥")
    p_check.add_argument("--timeout", type=int, default=10, help="è¯·æ±‚è¶…æ—¶ç§’æ•°")
    p_check.add_argument("--ua", default=DEFAULT_UA, help=f"User-Agentï¼Œé»˜è®¤ {DEFAULT_UA}")
    p_check.set_defaults(func=cmd_check)

    p_add = sub.add_parser(
        "add",
        aliases=["ad"],
        help="æ·»åŠ  provider å¹¶æ³¨å†Œå…¶å…¨éƒ¨æ¨¡å‹ï¼ˆæ”¯æŒäº¤äº’è¾“å…¥ï¼‰",
        formatter_class=argparse.RawTextHelpFormatter,
        epilog=(
            "ç¤ºä¾‹:\n"
            "  opm ad --name myp --base-url https://api.xxx.com/v1 --api-key <key>\n"
            "  opm ad --name demo2 --base-url https://api.xxxx.com/v1 --api-key <key> --validate-chat\n"
            "  opm ad --name demo2 --base-url https://api.xxxx.com/v1 --api-key <key> --validate-chat --max-probe 20\n"
        ),
    )
    p_add.add_argument("--name", default="", help="provider åç§°ï¼Œä¾‹å¦‚: myproviderï¼›ä¸å¡«åˆ™äº¤äº’è¾“å…¥")
    p_add.add_argument("--base-url", default="", help="ä¾‹å¦‚: https://api.xxx.com/v1ï¼›ä¸å¡«åˆ™äº¤äº’è¾“å…¥")
    p_add.add_argument("--api-key", default="", help="API Keyï¼›ä¸å¡«åˆ™äº¤äº’è¾“å…¥")
    p_add.add_argument("--api", default="openai-completions", help="API ç±»å‹ï¼Œé»˜è®¤ openai-completions")
    p_add.add_argument("--inputs", default="text image", help="æ¨¡å‹è¾“å…¥ç±»å‹ï¼Œç©ºæ ¼/é€—å·åˆ†éš”ï¼Œé»˜è®¤ text image")
    p_add.add_argument("--context-window", type=int, default=131072, help="contextWindow é»˜è®¤ 131072")
    p_add.add_argument("--max-tokens", type=int, default=8192, help="maxTokens é»˜è®¤ 8192")
    p_add.add_argument("--timeout", type=int, default=10, help="è¯·æ±‚è¶…æ—¶ç§’æ•°")
    p_add.add_argument("--ua", default=DEFAULT_UA, help=f"User-Agentï¼Œé»˜è®¤ {DEFAULT_UA}")
    p_add.add_argument("--validate-chat", action="store_true", help="æ·»åŠ å‰éªŒè¯ chat/completionsï¼Œä»…æ³¨å†Œå¯è°ƒç”¨æ¨¡å‹")
    p_add.add_argument("--max-probe", type=int, default=0, help="éªŒè¯æ¨¡å‹æ•°é‡ä¸Šé™ï¼Œ0=éªŒè¯å…¨éƒ¨")
    p_add.add_argument("--no-restart", action="store_true", help="ä»…æ”¹é…ç½®ï¼Œä¸é‡å¯ gateway")
    p_add.set_defaults(func=cmd_add)

    p_rm = sub.add_parser("remove", aliases=["rm"], help="åˆ é™¤ provider å¹¶æ¸…ç†å·²æ³¨å†Œæ¨¡å‹ï¼ˆæ”¯æŒæ‰¹é‡/åºå·ï¼‰")
    p_rm.add_argument("--name", help="å•ä¸ª provider åç§°æˆ–åºå·ï¼ˆå¯ç•™ç©ºï¼Œä¼˜å…ˆ namesï¼‰", default="")
    p_rm.add_argument("--names", help="æ‰¹é‡åˆ é™¤ï¼Œæ”¯æŒåºå·/åç§°ï¼Œç©ºæ ¼åˆ†éš”ï¼Œä¾‹å¦‚ 1 3 myprovider", default="")
    p_rm.add_argument("--no-restart", action="store_true", help="ä»…æ”¹é…ç½®ï¼Œä¸é‡å¯ gateway")
    p_rm.set_defaults(func=cmd_remove)

    p_sync = sub.add_parser(
        "sync",
        aliases=["sy"],
        help="æŠŠ provider çš„æ¨¡å‹æ³¨å†Œè¿› agents.defaults.modelsï¼Œå¯é€‰å•ä¸ª/å¤šé€‰/åºå·",
        formatter_class=argparse.RawTextHelpFormatter,
        epilog=(
            "ç¤ºä¾‹:\n"
            "  opm sy --providers demo2 --validate-chat\n"
            "  opm sy --providers demo2 --validate-chat --prune\n"
            "  opm sy --providers 2 3 --validate-chat --timeout 12 --max-probe 50\n"
        ),
    )
    p_sync.add_argument("--providers", default="", help="æŒ‡å®šè¦åŒæ­¥çš„ providerï¼ˆåºå·æˆ–åç§°ï¼Œç©ºæ ¼åˆ†éš”ï¼‰ï¼›ç©ºåˆ™å…¨éƒ¨")
    p_sync.add_argument("--validate-chat", action="store_true", help="åŒæ­¥å‰éªŒè¯ chat/completionsï¼Œä»…æ³¨å†Œå¯è°ƒç”¨æ¨¡å‹")
    p_sync.add_argument("--prune", action="store_true", help="é…åˆ --validate-chatï¼šæ¸…ç†å·²æ³¨å†Œä½†éªŒè¯å¤±è´¥çš„æ¨¡å‹")
    p_sync.add_argument("--timeout", type=int, default=10, help="éªŒè¯è¯·æ±‚è¶…æ—¶ç§’æ•°")
    p_sync.add_argument("--ua", default=DEFAULT_UA, help=f"éªŒè¯è¯·æ±‚ User-Agentï¼Œé»˜è®¤ {DEFAULT_UA}")
    p_sync.add_argument("--max-probe", type=int, default=0, help="æ¯ä¸ª provider éªŒè¯æ¨¡å‹æ•°é‡ä¸Šé™ï¼Œ0=éªŒè¯å…¨éƒ¨")
    p_sync.add_argument("--no-restart", action="store_true", help="ä»…æ”¹é…ç½®ï¼Œä¸é‡å¯ gateway")
    p_sync.set_defaults(func=cmd_sync)

    p_list = sub.add_parser("list", aliases=["ls"], help="åˆ—å‡º provider ä¸æ³¨å†ŒçŠ¶æ€ï¼ˆå¸¦åºå·ï¼‰")
    p_list.set_defaults(func=cmd_list)

    p_models = sub.add_parser("models", aliases=["md"], help="åˆ—å‡ºæŸä¸ª provider çš„æ¨¡å‹ï¼ˆå¸¦åºå·ï¼‰")
    p_models.add_argument("--provider", required=True, help="provider åºå·æˆ–åç§°")
    p_models.set_defaults(func=cmd_models)

    p_switch = sub.add_parser("switch", aliases=["sw"], help="åˆ‡æ¢é»˜è®¤æ¨¡å‹ï¼šprovider + æ¨¡å‹åºå·/åç§°")
    p_switch.add_argument("--provider", default="", help="provider åºå·æˆ–åç§°ï¼›ä¸å¡«åˆ™äº¤äº’é€‰æ‹©")
    p_switch.add_argument("--model", default="", help="æ¨¡å‹åºå·æˆ–æ¨¡å‹ idï¼Œç©ºåˆ™å–è¯¥ provider ç¬¬ä¸€ä¸ª")
    p_switch.add_argument("--session", action="store_true", help="åŒæ­¥åˆ‡æ¢å½“å‰ä¼šè¯æ¨¡å‹ï¼ˆ/model <provider/model>ï¼‰")
    p_switch.add_argument("--no-restart", action="store_true", help="ä»…æ”¹é…ç½®ï¼Œä¸é‡å¯ gateway")
    p_switch.set_defaults(func=cmd_switch)

    p_alias = sub.add_parser("alias-install", aliases=["ai"], help="å®‰è£…å‘½ä»¤åˆ«åï¼ˆè½¯é“¾æ¥ï¼‰ï¼Œé»˜è®¤ opm")
    p_alias.add_argument("--name", default="opm", help="åˆ«ååç§°ï¼Œé»˜è®¤ opm")
    p_alias.add_argument("--path", default="", help="å¯é€‰ï¼šæŒ‡å®šå®‰è£…è·¯å¾„ï¼ˆé»˜è®¤ä¸º /usr/local/binï¼Œå¤±è´¥åˆ™ ~/binï¼‰")
    p_alias.set_defaults(func=cmd_alias)

    return p


def main():
    # äº¤äº’ä¸»ç•Œé¢ï¼šopm -h è¿›å…¥ä¸»èœå•
    argv = sys.argv[1:]
    if not argv or "-h" in argv or "--help" in argv:
        return menu_loop()

    # éœ€è¦æŸ¥çœ‹ä¼ ç»Ÿ CLI å¸®åŠ©æ—¶ä½¿ç”¨ --cli-help
    if "--cli-help" in argv:
        argv = [x for x in argv if x != "--cli-help"] + ["--help"]

    parser = build_parser()
    try:
        args = parser.parse_args(argv)
        return args.func(args)
    except KeyboardInterrupt:
        print("\nğŸ‘‹ å·²é€€å‡º OPM")
        return 130
    except SystemExit as e:
        # argparse çš„æ­£å¸¸é€€å‡ºï¼ˆä¾‹å¦‚ --helpï¼‰
        return int(e.code) if isinstance(e.code, int) else 0
    except Exception as e:
        eprint(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
        return 1


if __name__ == "__main__":
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print("\nğŸ‘‹ å·²é€€å‡º OPM")
        sys.exit(130)

